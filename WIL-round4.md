# WIL - 4주차 (Transactional Operation)

## 🧠 이번 주에 새로 배운 것
- 트랜잭션
- 동시성 제어
- 비관적 락 / 낙관적 락
- 동시성 테스트

## 💭 이런 고민이 있었어요
1. 주문 트랜잭션에 외부 시스템 전송 포함 여부에 대한 고민
- 외부 시스템으로 전송된 주문 정보는 다시 Rollback이 어려움
- 일단 주문 트랜잭션에 포함시키지 않고 컨트롤러에서 성공한 주문 정보를 외부 시스템으로 전송하도록 배치함
2. 좋아요 기능에 대해 비관적 락 적용
- 낙관적 락 적용 시도 후 테스트 ➡️ 100개의 시도 중 15개만 성공
- 재시도 로직 적용 후 테스트 ➡️ 100개의 시도 중 15개만 성공 (재시도 자체가 또 다른 충돌 양산)
- 비관적 락 적용 시도 후 테스트 ➡️ 100개의 시도 모두 성공 (정확성이 높음)
3. 적당한 스레드 수
- 동시성 테스트 시 전체 요청 수를 몇 개의 스레드를 실행하여 처리할 건지 결정해야 함
- 스레드 수를 줄이면 경합 상황이 유도되고, 스레드 수를 늘리면 최대 부하를 테스트할 수 있는데 어떻게 판단할지 고민됨
4. ProductLikeSummary 도입
- 기존에는 좋아요 기능이 수행되면 해당 유저 - 상품을 저장하는 방식만 구현했었음
- 좋아요 수를 빠르게 조회하고 상품 리스트 조회 시 좋아요 수로 정렬하는 기능을 구현하기 쉽게 Summary 도입
5. 가독성 좋은 코드에 관한 고민
- 주문 흐름: 상품 재고 확인 / 쿠폰 적용 및 차감 / 포인트 확인 및 차감
- 각 단계를 각각 Facade 하위의 ApplicationService에 맡기는 것이 나은지 고민됨 

## 💡 앞으로 실무에 써먹을 수 있을 것 같은 포인트
- DB 격리수준에 대해서 쿼리를 직접 쳐보면서 이해할 수 있었다. DB 락 문제는 실무에서도 빈번히 발생하는 문제이기 때문에 도움이 될 것 같다.
- 실제로 배치가 수행되는 시점에 해당 테이블에 다른 트랜잭션이 접근하여 문제가 발생한 적이 있었는데 근본적인 원인 해결을 해볼 수 있을 것 같다.

## 🤔 아쉬웠던 점 & 다음 주에 해보고 싶은 것
- 낙관적 락 테스트를 다양한 변수를 가지고 실험해보지 못한 것이 아쉬웠다.
- 현재는 전부 비관적 락을 적용했는데 다음 주에 리팩토링 하면서 어떤 걸 선택해야할지 고민을 더 해볼 것이다.
